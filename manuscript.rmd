---
bibliography: manuscript.bib
csl: pnas.csl
output:
  pdf_document:
    fig_caption: yes
    keep_tex: yes
  word_document: default
---

```{r setup, message=FALSE, echo=FALSE, warning=FALSE}

	knitr::opts_chunk$set( 
		echo=FALSE,
		message=FALSE, 
		warning=FALSE,
		dev="png", 
		# dev.args=list( compression="lzw" ), # for tiff
		dpi=600,
		cache=TRUE
	)


```

```{r preliminaries, cache=FALSE}

	# The following should be installed from github with the specified 
	# devtools command. You will need to install devtools first.
	library( treeio ) # devtools::install_github("GuangchuangYu/treeio")
	library( ggtree ) # devtools::install_github("GuangchuangYu/ggtree")
	library( hutan ) # devtools::install_github("caseywdunn/hutan")

	# The rest can be installed from CRAN
	library( ape )
	library( digest )
	library( geiger )
	library( ggrepel )
	library( gridExtra )
	library( magrittr )
	library( phytools )
	library( stringr )
	library( tidyverse )

	source( "functions.R" )
	set.seed( 23456 )

```

```{r load_data}
	
	# Load data and analysis results generated by 
	# manuscript_kernel.R
	load("manuscript.RData")

```

\hyphenation{analyzing}

# Pairwise comparisons across species are problematic when analyzing functional genomic data

Casey W. Dunn^1,2^*, Felipe Zapata^3^, Catriona Munro^1^, Stefan Siebert^4^, Andreas Hejnol^5^

^1^ Department of Ecology and Evolutionary Biology, Brown University, Providence, RI, 02912, USA

^2^ Current address: Department of Ecology and Evolutionary Biology, Yale University, New Haven, CT, 06511, USA

^3^ Department of Ecology and Evolutionary Biology, University of California Los Angeles, Los Angeles, CA, 90095, USA

^4^ Department of Molecular & Cellular Biology, University of California at Davis, Davis, CA, 95616, USA

^5^ Sars International Centre for Marine Molecular Biology, University of Bergen, Bergen, 5006, Norway


\* Corresponding author, casey.dunn@yale.edu


## Abstract

There is considerable interest in comparing functional genomic data across species. One goal of such work is to provide an integrated understanding of genome and phenotype evolution. Most comparative functional genomic studies have relied on multiple pairwise comparisons between species, an approach that does not incorporate information about the evolutionary relationships among species. The statistical problems that arise from not considering these relationships can lead pairwise approaches to the wrong conclusions, and are a missed opportunity to learn about biology that can only be understood in an explicit phylogenetic context. Here we examine two recently published studies that compare gene expression across species with pairwise methods, and find reason to question the original conclusions of both. One study interpreted pairwise comparisons of gene expression as support for the ortholog conjecture, the hypothesis that orthologs tend to have more similar attributes (expression in this case) than do paralogs. The other study interpreted pairwise comparisons of embryonic gene expression across distantly related animals as evidence for a distinct evolutionary process that gave rise to phyla. In each study, distinct patterns of pairwise similarity among species were originally interpreted as evidence of particular evolutionary processes, but instead we find they reflect species relationships. These reanalyses concretely demonstrate the inadequacy of pairwise comparisons for analyzing functional genomic data across species. It will be critical to adopt phylogenetic comparative methods in future functional genomic work. Fortunately, phylogenetic comparative biology is also a rapidly advancing field with many methods that can be directly applied to functional genomic data.

## Significance

Comparisons of genome function between species are providing important insight into the evolutionary origins of diversity. Here we demonstrate that comparative functional genomics studies can come to the wrong conclusions if they do not take the relationships of species into account and instead rely on pairwise comparisons between species, as is common practice. We re-examined two previously published studies and found problems with pairwise comparisons that draw both their original conclusions into question. One study found support for the ortholog conjecture and the other concluded that the evolution of gene expression differed in pattern and process between animal phyla versus within animal phyla. Our results demonstrate that to answer evolutionary questions about genome function, it is critical to consider evolutionary relationships.

\pagebreak

## Introduction

The focus of genomic research has quickly shifted from describing genome sequences to functional genomics, the study of how genomes "work" using tools that measure functional attributes such as expression, chromatin state, and transcription initiation. Functional genomics, in turn, is now becoming more comparative-- there is great interest in understanding how functional genomic variation across species gives rise to a diversity of development, morphology, physiology, and other phenotypes [@Wray:2013gh]. These analyses are critical to transferring functional insight across species, and will grow in importance in coming years.

![Pairwise and phylogenetic comparative approaches, illustrated on an example gene tree with multiple genes per species. The internal nodes of the tree are speciation and gene duplication events. (*A*) Many comparative functional genomic studies rely on pairwise comparisons, where traits of each gene are compared to traits of other genes across species. This leads to many more comparisons than unique observations, making each comparison dependent on others. (*B*) Comparative phylogenetic methods, including phylogenetic independent contrasts [@Felsenstein:1985ua], make a smaller number of independent comparisons, where each contrast measures independent changes along different branches. Phylogenetic approaches are rarely used for functional genomic studies.](Figure_overview.pdf)

Over the last three decades, a rich set of phylogenetic comparative methods has been developed to address the challenges and opportunities of trait comparisons across species [@Felsenstein:1985ua; @Grafen:1989um; @Pagel:1999gc; @Revell:2012jd; @FitzJohn:2012ey; @Uyeda:2014jl; @Garamszegi:2014ew; @Jhwueng:2013fi; @Rohlfs:2015bd]. A central challenge is the dependence of observations across species due to the evolutionary history of species -- more closely related species share more traits because they have a more recent common ancestor. This violates the fundamental assumption of observation independence in standard statistical methods. Phylogenetic comparative methods address this dependence. They have largely been applied to morphological and ecological traits, but are just as relevant to functional genomics [@Barker:2005be]. Even so, most comparative functional genomic studies have abstained from phylogenetic approaches and instead rely on multiple pairwise comparisons across species (Fig. 1*A*). This leaves comparative functional genomic studies susceptible to statistical problems and is a missed opportunity to ask questions that are only accessible in an explicit phylogenetic context.

Phylogenetic comparative methods account for evolutionary history and explicitly model trait change along the branches of evolutionary trees (*e.g.*, Fig. 1*B*). The value of these methods relative to pairwise comparisons has been repeatedly shown in analyses of other types of character data [@Garland:2005ek; @Ricklefs:1996wb; @Chamberlain:2012vx; @OMeara:2012gq]. One reason that comparative functional genomic studies have not embraced phylogenetic approaches is that there has not yet been a concrete demonstration that pairwise and phylogenetic comparative methods can lead to different results when considering functional genomic data. Here we examine this issue by re-evaluating the pairwise comparisons in two recent studies that compared gene expression across species.

The first study, Kryuchkova-Mostacci and Robinson-Rechavi (KMRR) [@KryuchkovaMostacci:2016iw], analyzed multiple vertebrate expression datasets to test the ortholog conjecture - the hypothesis that orthologs tend to have more conserved attributes (specificity of expression across organs in this case) than do paralogs [@Nehrt:2011bm; @Koonin:2005fp]. Using pairwise comparisons (Fig. 1*A*), they found lower expression correlation between paralogs than between orthologs and interpreted this as strong support for the ortholog conjecture. 

The second comparative functional genomic study we evaluate here is Levin *et al.* [@Levin:2016bp]. This study analyzed gene expression through the course of embryonic development for ten animal species, each from a different phylum. Using pairwise comparisons, they found there is more evolutionary variance in gene expression at a mid phase of development than there is at early and late phases. They suggest that this supports an "inverse hourglass" model for the evolution of gene expression, in contrast with the "hourglass" model previously proposed for closely related species [@Kalinka:2010dw]. Furthermore, they suggested that this provides biological justification for the concept of phyla. We previously described concerns with the interpretations of this result [@Hejnol:2016hw]. Here we address the analyses themselves by examining the structure of the pairwise comparisons.


## Results and Discussion

### KMRR Reanalysis

#### Original pairwise test of the ortholog conjecture

KMRR [@KryuchkovaMostacci:2016iw] sought to test the ortholog conjecture. The ortholog conjecture [@Nehrt:2011bm] is the proposition that orthologs (genes that diverged from each other due to a speciation event) have more similar attributes than do paralogs (genes that diverged from each other due to a gene duplication event). The ortholog conjecture can and has been applied to diverse attributes, including molecular sequence, biochemical function, and, as in the study considered here, expression. It has important biological and technical implications. It shapes our understanding of the functional diversity of gene families. It is also used to relate findings from well-studied genes to homologous genes that have not been investigated in detail. While the ortholog conjecture describes a specific pattern of functional diversity across genes, it is also articulated as a hypothesis about the process of evolution-- that there is greater evolutionary change in gene attributes following a duplication event than a speciation event. 

Despite its importance, there have been relatively few tests of the ortholog conjecture. Previous work has shown that ontology annotations are not sufficient to test the ortholog conjecture [@Chen:2012jz; @Thomas:2012hz]. Analyses of domain structure were consistent with the ortholog conjecture [@Forslund:2011cw]. There have been few tests of the ortholog conjecture with regards to gene expression [@Chen:2012jz], and KMRR is one of the most detailed to date.

KMRR considered several publicly available datasets of gene expression across tissues and species. Their expression summary statistic is tau [@Yanai:2005dh, @KryuchkovaMostacci:2016in], an indicator of tissue specificity of gene expression. Tau can range from a value of 0, which indicates no specificity (*i.e.*, uniform expression across tissues), to a value of 1, which indicates high specificity (*i.e.*, expression in only one tissue). Tau is convenient in that it is a single number of defined range for each gene, though of course since the original expression is multidimensional this means much information is discarded. This includes information about which tissue expression is specific to. For example, if one gene has expression specific to the brain and another expression specific to the kidney, both would have a tau of 1. 

The KMRR analyses are based on pairwise comparisons (Fig. 1*A*) between tau within each gene family. Rather than make every pairwise comparison within each gene tree, they considered only a subset of pairwise comparisons in each particular analysis. They first selected a focal species, which varied from analysis to analysis. Ortholog comparisons were limited to pairs that include this species, and the only paralogs considered were those with the highest expression in this species. Note that this subset of pairwise comparisons still sample the same changes multiple times.

They found the correlation coefficient of tau for orthologs to be significantly greater than the correlation coefficient of tau for paralogs, *i.e.* orthologs tend to have more similar expression than do paralogs. From this they concluded that their analyses support the ortholog conjecture. They also concluded that this pattern provides support for a particular evolutionary process, that "tissue-specificity evolves very slowly in the absence of duplication, while immediately after duplication the new gene copy differs" [@KryuchkovaMostacci:2016iw].

#### Phylogenetic reanalyses

We reanalyzed the KMRR study using phylogenetic comparative methods. We focused on one of the datasets included in their analyses, that of Brawand *et al.* 2011 [@Brawand:2011du]. This dataset is the best sampled in their analyses. It has gene expression data for six organs across ten species (nine mammals and one bird), eight of which were analyzed by KMRR and are further considered here. 

Many phylogenetic comparative methods are now available for addressing a wide range of questions relevant to comparative functional genomics. Some recent methods have been developed specifically for analyses of expression. For example, the Expression Variance and Evolution (EVE) model compares the ratio of within-species expression variance to between-species evolutionary expression variance in an explicit phylogenetic framework [@Rohlfs:2015bd]. It can test a variety of hypotheses, including lineage-specific expression level shifts. This method considers strict orthologs that all have the same gene tree, which is the same as the phylogeny of the species under consideration. However, for the re-analysis presented here we address different questions that consider a broad diversity of gene trees that include both speciation and different patterns of duplication. Phylogenetic independent contrasts [@Felsenstein:1985ua], the most widely used phylogenetic comparative method, is particularly well suited to this challenge.

For each internal node in each gene tree, we calculated the phylogenetic independent contrast [@Felsenstein:1985ua] (PIC) of tau. This is the difference in values of tau for descendant nodes scaled by the expected variance, which is largely determined by the lengths of the two branches that connect the node to its two descendants (Fig. 1*B*). These contrasts were then annotated by whether each is made across a speciation or duplication event. The original description of independent contrasts [@Felsenstein:1985ua] focused on assessing covariance between changes in two traits. Our use of contrasts is a bit different-- we look for differences in evolutionary changes of one trait (differential expression) between two categories of nodes (speciation and duplication). This is similar to previous applications of contrasts to examine shifts in evolutionary rates between clades [@Garland:1992jl]. Rather than compare the distributions of contrasts for nodes in different clades, as this previous work did, we compare the distributions of contrasts for nodes with different annotations (speciation or duplication). 

We mapped the tau values calculated by KMRR [@KryuchkovaMostacci:2016iw] for the Brawand *et al.* 2011 [@Brawand:2011du] dataset onto `r n_gene_trees %>% format(big.mark=",")` gene trees parsed from ENSEMBL Compara [@Herrero:2016jj]. These are the same pre-computed trees that the orthology/ paralogy annotations KMRR used are based on. `r length(gene_trees_pruned) %>% format(big.mark=",")` gene trees passed taxon sampling criteria (`r min_genes_with_expression %>% format(big.mark=",")` genes) after removing tips without tau values and had at least one speciation event. Of these, `r length(gene_trees_calibrated)  %>% format(big.mark=",")` were successfully time calibrated. These calibrated trees were used to calculate phylogenetic independent contrasts for `r nodes_contrast %>% filter(D=="Y") %>% nrow() %>% format(big.mark=",")` duplication nodes and `r nodes_contrast %>% filter(D=="N") %>% nrow() %>% format(big.mark=",")` speciation nodes (Tables S1, S2). One of these trees is presented in *SI Appendix* Fig. S1 to demonstrate the analysis.

It is essential to have a null hypothesis that makes a distinct prediction from the prediction of the hypothesis under consideration. A suitable null hypothesis in this case is that there is no difference in the evolution of expression following speciation or duplication events [@Studer:2009bm]. Under this hypothesis, we would predict that contrasts across speciation nodes and duplication nodes are drawn from the same distribution. Under the alternative hypothesis specified by the ortholog conjecture, that there is a higher rate of change following duplication events than speciation events, we would expect to see the distribution of duplication contrasts shifted to higher values relative to the speciation contrasts.

We did not find increased evolutionary change in expression following duplication events as compared to speciation events (Fig. 2*B*). The Wilcoxon rank test does not reject the null hypothesis that the rate of evolution following duplications is the same as or less than the rate following speciation ($P=`r wilcox_test_result`$). Our phylogenetic comparative analysis, unlike the previously published pairwise comparative analysis [@KryuchkovaMostacci:2016iw], therefore finds no support for the ortholog conjecture in this system. This result holds when we exclude the genes with the lowest phylogenetic signal according to Blomberg's $K$ [@Blomberg:2003jg] and is robust to model selection [@Akaike:1974ih; @Posada:2004ix; @Pennell:2014jf] (*SI Appendix*, *SI Appendix* Fig. S2).

We examined the possibility that ascertainment biases were differentially impacting the inference of expression evolution following duplication and speciation events. Such a bias might obscure support for the ortholog conjecture. We focused on two possible sources of bias, node depth and branch length. We found no evidence that either affected our results (*SI Appendix*, Fig. S3). We also examined the sensitivity of the results to the calibration times applied to speciation events on the gene trees. This is important because it is expected that genes from separate species have a common ancestor older than the time at which the species diverged from each other [@Takahata:1989uh; @Degnan:2009hr]. There is also uncertainty associated with the timing of these speciation events. We added random noise to the calibration times in replicate analyses, and all still failed to reject the null hypothesis (*SI Appendix*).

An additional concern is that within-species expression variation is not considered when making comparisons of tau across homologous genes. Neglecting within species variation is expected to mislead phylogenetic comparative analyses in some cases [@Ives:2007cw; @Felsenstein:2008cl; @Rohlfs:2015bd]. Since branch length describes expected trait variation [@Felsenstein:1985ua], within species variation can be modeled by extending the terminal branches of each gene phylogeny [@Ives:2007cw]. We modeled within-species variation by extending each terminal branch by 7 million years. This value was selected because it corresponds to the age of the clade Hominini (defined by the most recent common ancestor of humans and chimpanzees), the shallowest node in the phylogeny of examined species. This provides an opportunity to assess the impact that extreme within-species variation (*i.e.*, as large as the variance between humans and chimpanzees and their most recent common ancestor) would have on our findings. These analyses still do not reject the null hypothesis, and do not provide support for the ortholog conjecture (*SI Appendix*, Fig. S4).


#### Understanding the incongruence between pairwise and phylogenetic methods

In order to better understand why our phylogenetic analysis supports a different conclusion (*i.e.*, no support for the ortholog conjecture) than the published analysis of KMRR [@KryuchkovaMostacci:2016iw] (*i.e.*, strong support for the ortholog conjecture), we first checked to make sure we could reproduce their result based on pairwise analyses. This is important since we are only looking at a subset of the data they considered, the Brawand *et al.* 2011 [@Brawand:2011du] dataset for gene trees that could be successfully time calibrated. In their Fig. 1 [@KryuchkovaMostacci:2016iw], they present a higher tau correlation coefficient between ortholog pairs than paralog pairs. We find the same here, with correlation coefficients of `r signif( ortholog_r$estimate, 2)` ($P`r format_p(ortholog_r)`$) for orthologs and `r signif( paralog_r$estimate, 2)` ($P`r format_p( paralog_r )`$) for paralogs. 

Why is it that pairwise methods and phylogenetic methods lead to opposite conclusions? One reason is that multiple pairwise comparisons repeatedly sample the same evolutionary changes and in so doing violate statistical assumptions of independence, whereas phylogenetic comparative methods make multiple independent comparisons across non-overlapping branches of the tree. The other reason is that pairwise comparisons and phylogenetic comparative methods describe different things. Pairwise comparisons describe contemporary patterns, while phylogenetic methods infer historical processes [@OMeara:2012gq]. Paralogs can be more different than orthologs even when the processes of evolution following speciation and duplication are the same. Any difference could be due to the structure of the gene phylogenies alone. If paralogs tend to be more distantly related to each other than orthologs, then there would be more time for differences to accumulate even if the rate of change is the same between the two. This is, in fact, the case for these data. While the mean distance (*i.e.*, total branch length) between orthologs is `r round( ortholog_distance_mean, 1 )` million years, the mean distance between paralogs is `r round( paralog_distance_mean, 1 )` million years. This is because the oldest speciation event is by definition the most recent common ancestor of the species included in the study, but many gene families underwent duplication before this time.

To test the hypothesis that ancient duplications that precede the oldest speciation event (*SI Appendix*, Fig. S5*A*) impact the lower correlation of tau between paralogs than between orthologs, we removed them. When we consider only the duplication events the same age or younger than the oldest speciation event (*SI Appendix*, Fig. 5*B*), the paralog correlation coefficient increases from `r signif( paralog_r$estimate, 2)` to `r signif( paralog_subset_r$estimate, 2)` ($P`r format_p(paralog_subset_r)`$). This is much closer to the ortholog correlation of `r signif( ortholog_r$estimate, 2) `. 


```{r Fig_2, fig.width=7, fig.height=6.5, fig.cap="Pairwise (left column - *A, C, E*) and phylogenetic (right column - *B, D, F*) analyses of the original data (first row - *A, B*), data simulated under the null hypothesis (second row - *C, D*), and data simulated under the ortholog conjecture (third row- *E, F*). In the pairwise plots, each point indicates the correlation coefficient of tau for a set of pairwise comparisons annotated with a specific node name (e.g, Primates) and event type (speciation or duplication, giving rise respectively to orthologs and paralogs). The phylogenetic plots show the difference between the density distributions for tau phylogenetic contrasts for speciation and duplication events, where a value above 0 indicates an excess of speciation contrasts in the indicated interval. A horizontal line at 0 would indicate that the density distributions are identical. The top left pane (*A*) reproduces the pattern presented in Fig. 2*A* of KMRR [@KryuchkovaMostacci:2016iw] of higher correlation across speciation events than duplication events, which they took as evidence of the ortholog conjecture. The recovery of a similar  pattern under both simulations (*C, E*) indicates that this pairwise approach does not make distinct testable predictions. The phylogenetic analysis of the original data (*B*) does not show an excess of larger contrasts for duplication events and does not reject the null hypothesis, providing no support for the ortholog conjecture. The bottom right panes validate the phylogenetic approach by showing that it does not reject the null when data are simulated under the null (*D*), but does reject the null when data are simulated under the ortholog conjecture (*F*)."}

	g_pair_empirical = 
		pairwise_summary %>% 
			filter( ! is.na( D ) ) %>%
			group_by( Event, label ) %>% 
			summarise( cor.test( tau_a, tau_b )$estimate, n=n() ) %>% 
			rename( rho=`cor.test(tau_a, tau_b)$estimate` ) %>%
			rename( clade = label ) %>% 
			left_join( calibration_times, clade=clade ) %>%
			ggplot() + 
				geom_point( aes( x=age, y=rho, col=Event ), size=3 ) +
				theme_classic() +
				xlab( "Clade Age (million years)" ) +
				ylab( "Correlation Coefficient" ) +
				ylim( 0, 1 ) +
				ggtitle( "A      Empirical, pairwise" ) +
				guides( colour = guide_legend( override.aes = list( shape = 15 ) ) ) +
				theme( 
				legend.justification=c( 1, 1 ), 
				legend.position=c( 1, 1 ), 
				legend.title=element_blank() )

	g_pair_null = 
		pairwise_sim_null_summary %>% 
		filter( ! is.na( D ) ) %>%
		group_by( Event, label ) %>% 
		summarise( cor.test( tau_a, tau_b )$estimate, n=n() ) %>% 
		rename( rho=`cor.test(tau_a, tau_b)$estimate` ) %>%
		rename( clade = label ) %>% 
		left_join( calibration_times, clade=clade ) %>%
		ggplot() + 
			geom_point( aes( x=age, y=rho, col=Event ), size=3 ) +
			theme_classic() +
			xlab( "Clade Age (million years)" ) +
			ylab( "Correlation Coefficient" ) +
			ylim( 0, 1 ) +
			ggtitle( "C      Null simulation, pairwise" ) +
			theme( legend.position="none" )
	
	g_pair_oc = 
		pairwise_sim_oc_summary %>% 
		filter( ! is.na( D ) ) %>%
		group_by( Event, label ) %>% 
		summarise( cor.test( tau_a, tau_b )$estimate, n=n() ) %>% 
		rename( rho=`cor.test(tau_a, tau_b)$estimate` ) %>%
		rename( clade = label ) %>% 
		left_join( calibration_times, clade=clade ) %>%
		ggplot() + 
			geom_point( aes( x=age, y=rho, col=Event ), size=3 ) +
			theme_classic() +
			xlab( "Clade Age (million years)" ) +
			ylab( "Correlation Coefficient" ) +
			ylim( 0, 1 ) +
			ggtitle( "E      OC simulation, pairwise" ) +
			theme( legend.position="none" )

	grid.arrange(
		g_pair_empirical,
		make_contrast_plot(nodes_contrast) + 
			ggtitle( "B      Empirical, phylogenetic" ),
		# For the rest, put spaces in labels so you can't see them but alignment is 
		# same as those with labels
		g_pair_null + 
			xlab( "  " ) + 
			ylab( "  " ), 
		make_contrast_plot(nodes_sim_null_contrast) + 
			xlab( "  " ) + 
			ylab( "  " ) + 
			ggtitle( "D      Null simulation, phylogenetic" ),
		g_pair_oc + 
			xlab( "  " ) + 
			ylab( "  " ),
		make_contrast_plot(nodes_sim_oc_contrast) + 
			xlab( "  " ) + 
			ylab( "  " ) + 
			ggtitle( "F      OC simulation, phylogenetic" ),
		ncol = 2
	)


```


The KMRR study did investigate the impact of node age on correlation, but in a different way. In their Fig. 2 [@KryuchkovaMostacci:2016iw], they grouped orthologs and paralogs according to the ENSEMBL node name of their most recent common ancestor, and plotted the correlation of tau for each of these groups by the node age. They found that across the investigated range of node ages, ortholog pairs have higher tau correlation than paralogs. We confirmed that we can replicate this result (Fig. 2*A*). There are several difficulties with interpreting this plot, though. First, it does not just reflect the evolutionary processes that generated the data, it is also impacted by the phylogenies along which these processes acted. The expected covariance of traits that evolve under neutral processes is in fact defined by the phylogeny [@Grafen:1989um]. Second, the correlation for each group is based on multiple non-independent pairwise comparisons. Third, instead of using the actual age of duplication events, the age of an adjacent named node in the species tree is used.

To better understand this plot (Fig. 2*A*), we performed simulations of tau on the calibrated gene trees. We did not modify the gene tree topologies or their inferred histories of duplication and loss. First, we simulated the evolution of tau under the null model that it evolves at the same rate following duplication and speciation events. Under the null model, the plot of correlation coefficient to node age (Fig. 2*C*) is very similar as for the observed data (Fig. 2*A*). As in the original study, there is higher correlation coefficient across orthologs (`r signif( ortholog_r_sim_null$estimate, 2 )`, $P`r format_p(ortholog_r_sim_null)`$) than paralogs (`r signif( paralog_r_sim_null$estimate, 2 )`, $P`r format_p(paralog_r_sim_null)`$) when not considering node age. Phylogenetic analysis of the data simulated under the null hypothesis (Fig. 2*D*) do not reject the null hypothesis (Wilcoxon $P=`r wilcox_oc( nodes_sim_null_contrast ) %>% round( 3 )`$), as expected.

We next simulated the evolution of tau under the ortholog conjecture, where the rate of evolution of tau following duplication was `r dup_adjust` fold the rate following speciation. The pairwise results of this heterogeneous model (Fig. 2*E*) are nearly indistinguishable from the results under the null model (Fig. 2*C*), and also have a higher correlation coefficient for orthologs (`r signif( ortholog_r_sim_oc$estimate, 2 )`, $P`r format_p( ortholog_r_sim_oc )`$) than paralogs (`r signif( paralog_r_sim_oc$estimate, 2 )`, $P`r format_p( paralog_r_sim_oc )`$). The phylogenetic analysis of the ortholog conjecture simulation (Fig. 2*F*) does reject the null hypothesis (Wilcoxon $P=`r signif( wilcox_oc( nodes_sim_oc_contrast ), 2 )`$), as expected if the phylogenetic methods are working correctly.

These simulations have several implications. The pairwise comparisons used by KMRR cannot distinguish between the null hypothesis and ortholog conjecture. The pairwise results are strikingly similar under both hypotheses (Fig. 2*C*, 2*E*). These simulations also serve to validate the phylogenetic methods applied to this problem. As expected, our phylogenetic analysis of independent contrasts does not reject the null hypothesis when data are simulated under the null model, and does reject the null hypothesis when the data are simulated under the ortholog conjecture. In contrast to pairwise methods, the phylogenetic analyses can test explicit predictions based on hypotheses about evolutionary process.

```{r cor_structure}

	# The threshold of allowed fractional deviance of node age from clade age
	age_window = 0.1

	g_clade_age = pairwise_sim_null_summary %>% 
		rename( clade = label ) %>% 
		#filter( clade %in% speciation_clades ) %>%
		left_join( calibration_times, clade=clade ) %>% 
		filter( ! is.na( D ) ) %>%
		ggplot( aes( x = age, y = node_age, col = Event ) ) +
			geom_point( alpha = 0.1 ) +
			xlab( "Clade Age (million years)" ) +
			ylab( "Node Age (million years)" ) +
			xlim( 0, 1000) +
			ylim( 0, 1500 ) +
			ggtitle( "A" ) +
			theme_classic() +
			theme( legend.position="none" )
	
	pairwise_sim_null_summary_sub = 
		pairwise_sim_null_summary %>% 
		filter( ! is.na( D ) ) %>% rename( clade = label ) %>% 
		left_join( calibration_times, clade=clade ) %>% 
		filter( node_age > ( ( 1 - age_window ) * age ) ) %>%
		filter( node_age < ( ( 1 + age_window ) * age ) ) 
	
	g_sub = 
		pairwise_sim_null_summary_sub %>%
		group_by( Event, clade ) %>% 
		summarise( cor.test( tau_a, tau_b )$estimate, n=n() ) %>% 
		rename( rho=`cor.test(tau_a, tau_b)$estimate` ) %>%
		left_join( calibration_times, clade=clade ) %>%
		ggplot() + 
			geom_point( aes( x=age, y=rho, col=Event ), size=3 ) +
			theme_classic() +
			xlab( "Clade Age (million years)" ) +
			ylab( "Correlation Coefficient" ) +
			xlim( 0, 1000) +
			ylim( 0, 1 ) +
			guides( colour = guide_legend( override.aes = list( shape = 15 ) ) ) +
			theme( 
				legend.justification=c( 1, 1 ), 
				legend.position=c( 1, 1 ), 
				legend.title=element_blank() ) +
			ggtitle( "B" )
	
	n_dup_original = 
		pairwise_sim_null_summary %>%
		filter( Event=="Duplication" ) %>%
		nrow()
	
	n_dup_remaining = 
		pairwise_sim_null_summary_sub %>%
		filter( Event=="Duplication" ) %>%
		nrow()
	
```

Since greater rates of expression evolution following duplication do not explain the lower correlation of tau values in the pairwise comparison plots (Fig. 2 *A, C, E*), this pattern must reflect some other property that is shared across these analyses. We found that the lower correlations for duplication comparisons can largely be explained by the greater variance in the age of duplication nodes. Each point in the pairwise correlation plot (Fig. 2 *A, C, E*) summarizes multiple pairwise comparisons across nodes of a given event type (speciation or duplication, as indicated by color) and clade in the species tree (Theria, Mammalia, Amniota, etc..., as indicated by the age of the clade along the x axis). These clade names in turn are derived from the node annotations in the ENSEMBL Compara trees, which apply clade names to both speciation and duplication nodes. While speciation nodes in the gene trees have a clear correspondence to clades in the species trees, duplication nodes do not since duplication can occur at any point along any branch in the species tree. Neighboring clade ages are therefore a very rough approximation of the age of duplication events. This is apparent when node ages derived from calibrated trees are plotted against the age of the clade annotations for each node (*SI Appendix*, Fig. S5*A*). Because duplication events that are all annotated with the same clade name can occur at very different times, pairwise comparisons across these nodes capture evolutionary changes in tau across very different different branch lengths. They therefore have lower correlation than pairwise comparisons made across speciation nodes. Of the `r n_dup_original %>% format(big.mark=",")` duplication nodes considered here, `r n_dup_remaining %>% format(big.mark=",")` have a node age (as determined by the time calibrated trees) within `r age_window * 100`% of their clade annotation. If only these duplication events closest to their annotated clade nodes are retained, the pattern of lower correlation of tau evolution for duplication events disappears for the dataset simulated under the null model (*SI Appendix*, Fig. S5*B*). This correction, though, comes at the high cost of discarding `r round( (n_dup_original - n_dup_remaining )/ n_dup_original * 100, 1 )`% of duplication nodes.

#### Implications for the ortholog conjecture

```{r implications}

	edge_p = wilcox.test( 
		edge_summary %>% filter( event_parent=="Duplication" ) %>% .$scaled_change, 
		edge_summary %>% filter( event_parent=="Speciation" ) %>% .$scaled_change, 
		alternative="greater" 
	)$p.value

	edge_summary_pass_k = edge_summary %>% filter( gene %in% genes_pass_k )

	edge_pass_k_p = wilcox.test( 
		edge_summary_pass_k %>% filter( event_parent=="Duplication" ) %>% .$scaled_change, 
		edge_summary_pass_k %>% filter( event_parent=="Speciation" ) %>% .$scaled_change, 
		alternative="greater" 
	)$p.value


```

There has been considerable recent interest in, and controversy about, the ortholog conjecture [@Koonin:2005fp; @Studer:2009bm; @Nehrt:2011bm; @Gabaldon:2013fi; @Altenhoff:2012ea]. While some studies have presented support for the ortholog conjecture, our results are consistent with multiple studies that have not [@Studer:2009bm; @Nehrt:2011bm; @Yanai:2004hk]. It should be noted that many areas of biology restrict the term "function" to describe the biochemical function of a gene, but the literature on gene duplication often uses "function" in a broader sense to include any gene attribute that could impact fitness, such as biochemical function, spatial expression, or binding. Since the ortholog conjecture can be applied to such diverse attributes, it is a heterogeneous and potentially idiosyncratic topic. For example, a recent integrated analysis of multiple gene attributes after duplication found extensive divergence in protein sequence but less divergence in expression [@Soria:2014bv]. In our analyses, we found that phylogenetic distance is a better predictor of the similarity of gene expression than is the history of gene duplication and speciation. The ortholog conjecture does not have to be an all or nothing proposition, even as it applies to expression. It may be that the rates of tissue-specific expression evolution following duplication are greater in some organisms, gene families, and evolutionary processes [@Gabaldon:2013fi]. The lack of support we find for the ortholog conjecture in this system, as well as the mixed results of others, does suggest that investigators should test for it in each situation rather than assume *a priori* that it is a dominant pattern in the diversity of gene expression. These tests should be done in an explicit phylogenetic framework. 

While empirical support for the ortholog conjecture has been mixed, theoretical work has suggested several mechanisms that could lead to increased rates of evolutionary change in expression and other gene traits following gene duplication. This has been a primary motivation for the extensive discussion of the ortholog conjecture. In his seminal work, Ohno [@Ohno:1970wm] outlined three outcomes of gene duplication, now often referred to as neofunctionalization (one gene copy can take on new functions while the other retains the old functions), subfunctionalization (each gene copy has a subset of the functions present in their most recent common ancestor), and conservation (each gene copy retains the same function). Neofunctionalization was the primary focus of early work on gene duplication, though it was not found to be a widespread outcome of duplication [@Hughes:1994ec]. The highly influential duplication-degeneration-complementation (DDC) model [@Force:1999tg; @Lynch:2000um] suggested that subfunctionalization could be a better explanation for the retention of both copies of a gene. It is built on the idea that gene copies that have each lost different functions would both be needed to fulfill all the functions present in their most recent common ancestor. Tests of the DDC model have had mixed results [@Huminiecki:2004dc]. A growing body of work suggests that retention and differentiation of genes is due to a variety of different mechanisms in different contexts, and that we should not necessarily expect one process to dominate over others [@Hahn:2009by]. Our lack of support for the ortholog conjecture suggests that whatever mechanisms lead to the retention of duplicated genes in the organisms considered here does not lead to changes in the tissue-specificity of gene expression as summarized by tau.

The DDC model is particularly interesting to further consider in this context since the summary statistic tau describes tissue specificity of expression. In the context of tissue-specific expression, the ortholog conjecture predicts a greater rate of evolutionary change in tau following duplication, without specifying the direction of the change. The DDC model predicts a specific type of change in expression following duplication -- subfunctionalization, which would increase tissue specificity, and therefore tau, following duplication. To test for this more specific prediction of DDC, we conducted additional analyses to see if there is a greater rate of increase in tau following duplication. For each branch in each gene tree, we inferred the change in tau and standardized this change by branch lengths. We found no evidence of increased tau following duplication relative to speciation (Wilcoxon $P=`r  edge_p %>% round( 3 )`$). This result also holds when we discarded the `r k_percentile` of genes with the lowest phylogenetic signal (Wilcoxon $P=`r  edge_pass_k_p %>% round( 3 )`$). These results are consistent with another recent study that found little support for neofunctionalization or subfunctionalization in expression of duplicated human genes, and instead proposed that dosage compensation drives most changes in expression following duplication in mammals [@Lan:2016ix]. Like the ortholog conjecture, DDC is not an all-or-nothing hypothesis. We fail to find support for it in these tissues in these species with the tau expression summary statistic, but it may hold in other contexts. DDC could still play a role in the retention of these genes, but with respect to other attributes such as biochemical functions rather than tissue-specific expression.

### Levin *et al.* reanalysis

#### Original pairwise analyses of developmental gene expression

![Distributions of pairwise similarity scores for each phase of development. Pairwise scores for the ctenophore are red. Wilcoxon test $P$ values for the significance of the differences between early-mid distributions and late-mid distributions are on the right. Model of variance, which is inversely related to similarity, is on the left. (*A*) The distributions as published by Levin *et al.* [@Levin:2016bp]. Low similarity (*i.e.*, high variance) in the mid phase of development was interpreted as support for an inverse hourglass model for the evolution of gene expression. The five least-similar mid phase scores were all from the ctenophore. The inset ctenophore image is by S. Haddock from phylopic.org. (*B*) The distributions after the exclusion of the ctenophore. The early and mid phase distributions are not statistically distinct.](levin_etal/Figure_levin.pdf)

Levin *et al.* [@Levin:2016bp] analyzed gene expression through the course of embryonic development for ten animal species, each from a different clade that has been designated as having the rank of phylum. They arrived at two major conclusions. First, animal development is characterized by a well-defined mid-developmental transition that marks the transition from an early phase of gene expression to a late stage of gene expression. Second, this transition helps explain the evolution of features observed among distantly related animals. Specifically, they concluded that animals from different phyla exhibit an "inverse hourglass" model for the evolution of gene expression, where there is more evolutionary variance in gene expression at a mid phase of development than there is at early and late phases. Closely related animals have previously been described as having an hourglass model of gene expression, where evolutionary variance in expression is greater early and late in development than at the midpoint of development [@Kalinka:2010dw; @DomazetLoso:2010cn]. Levin *et al.* conclude that this contrast between distantly and closely related animals provides biological justification for the concept of phyla and may provide a definition of phyla. 

Levin *et al.* [@Levin:2016bp] arrived at this conclusion by making multiple pairwise comparisons of ortholog expression data sampled throughout the course of embryonic development. For each species pair, they identified the orthologs shared by these species. This list of shared genes was different from species pair to species pair. They characterized each of these orthologs in each species as having expression that peaks in early, mid, or late temporal phase of development. They then calculated a similarity score for each temporal phase for each species pair based on the fraction of genes that exhibited the same patterns in each species. The distributions of similarity scores are plotted in their Fig. 4d [@Levin:2016bp], and their Kolmogorov-Smirnov (KS) tests indicated that the early distribution and late distribution were each significantly different from mid distribution ($P < 10^{-6}$ and $P < 10^{-12}$, respectively). This is the support they presented for the inverse hourglass model.


#### Pairwise comparisons oversample lineage-specific changes

We examined the matrix of pairwise comparisons used as the base for the KS tests and Fig. 4d in *Levin et al.* [@Levin:2016bp], and thus as support for the "inverse hourglass" model. We found several problems resulting from the use of multiple pairwise comparisons. The first problems are specific to this particular implementation of pairwise comparisons. We found that every data point was included twice because both reciprocal pairwise comparisons (which have the same values) were retained. As a consequence, there are 90 entries for the 45 pairwise comparisons, and by doubling the data the significance of the result appears stronger than it actually is. After removing the duplicate values, the p values are far less significant, 0.002 for the early-mid comparison and on the order of $10^{-6}$ for early-late. In addition, the test they used (KS test) is not appropriate for the hypothesis they seek to evaluate. The KS test does not just evaluate whether one distribution is greater than the other, it also tests whether the shape of the distributions are the same. The samples in this dataset are matched (*i.e.*, for each pairwise comparison there is a early, mid, and late expression value), which the KS test does not take into account. The Wilcoxon test is instead appropriate in this case. When applied to the de-duplicated data, the $P$ of this test is 0.02 for the early-mid comparison and on the order of $10^{-7}$ for early-late.

Once we addressed the issues above, we were able to explore more general issues that can be a problem when making multiple pairwise comparisons between species. We found that all five of the lowest values in the mid phase distribution (Fig. 3*A*) are for pairwise comparisons that include the ctenophore (comb jelly). When the nine pairwise comparisons that include the ctenophore are removed, there is no significant difference between the early phase and mid phase distributions ($P=0.14$ for the early-mid comparison and $P<10^{-5}$ for the late-mid comparison) and no support for the inverse hourglass (Fig. 3*B*). This highlights a well understood property of pairwise comparisons across species [@Felsenstein:1985ua; @Ackerly:1999iu]: evolutionary changes along a given branch, like those along the ctenophore branch, impact each of the multiple pairwise comparisons that includes that branch. The pairwise comparisons are therefore not independent - different pairwise comparisons are impacted by changes along some of the same branches (Fig. 1*A*). This can give the impression of a general pattern across the tree that is instead specific to changes along one part of the tree. The number of comparisons impacted by each change depends on the structure of the phylogenetic tree, *i.e.* how the species are related to each other. Phylogenetic comparative methods were developed specifically to address this problem [@Felsenstein:1985ua]. 

While we demonstrate problems with pairwise comparisons that impacts the Levin *et al.* analysis, we did not perform a phylogenetic reanalysis of this study, as we did for the KMRR study. This is because the similarity metric computed in the pairwise comparisons of Levin *et al.* is not suitable for phylogenetic analysis as it is based on different genes for different species pairs, and therefore cannot be modeled across the phylogeny. A full phylogenetic reanalysis would be possible using upstream analysis products to re-derive new expression summary statistics. 


### Phylogenetic comparative methods in functional genomics

We are not the first to apply phylogenetic comparative methods to functional genomic data. While the vast majority of comparative functional genomic studies have used standard pairwise similarity methods, a small number of comparative functional genomic studies have employed phylogenetic comparative approaches [@Oakley:2005ky; @Eng:2009gp; @Chang:2014hq; @Whitney:2011fw]. For instance, a phylogenetic ANOVA [@Rohlfs:2015bd] of the evolution of gene expression in strict orthologs improves statistical power and drastically reduces the rate of false positives relative to pairwise approaches.

Some of the most widely used phylogenetic comparative methods [@Felsenstein:1985ua; @Grafen:1989um] are already directly applicable to comparative functional genomic studies. There are also interesting new challenges, such as parameterizing differential expression so that species-specific technical biases are not mistaken for evolutionary changes in expression [@Dunn:2013cpa].

Branch lengths are fundamental to phylogenetic comparative methods, since the null expectation is that there are more changes along longer branches. In this study we applied four separate modifications of branch lengths. First, we time calibrated the gene trees so that nodes corresponding to the same speciation events had the same age across all trees. This is critical to making the comparisons of functional genomic traits equivalent across genes. Second, phylogenetic independent contrasts (including the implementation we use here) adjust internal branch lengths to accommodate the variation associated with estimating character states at internal nodes [@Felsenstein:1985ua]. Third, we randomized the calibration times to determine the sensitivity of the analyses to calibration times and the branch length estimations they impact (*SI Appendix*). Fourth, we extended terminal branch lengths to understand the potential impact of within-species variation (*SI Appendix*, Fig. S4). The first two of these modifications are technical requirements for the application of phylogenetic comparative methods. The second two explore the sensitivity of the analyses to branch length and the information they convey, and find that the results are robust to variation in branch length. This is encouraging for the future of phylogenetic comparative functional genomics, given that one concern of applying these methods is the challenge of estimating branch lengths.


## Conclusions

The problems we identify with pairwise comparisons in two recent functional genomics studies indicate that there are likely to be similar problems in other studies that use these methods. Future studies that compare functional genomic data across species will be compromised if they continue to use pairwise methods. Studies of evolutionary functional genomics should not be focused on the tips of the tree using pairwise comparisons. They should explicitly delve into the tree with phylogenetic comparative methods.

These analyses also illustrate how important it is to not conflate evolutionary patterns with the processes that generated them. Finding a pattern wherein paralogs tend to be more different than orthologs is not evidence that there are different processes by which orthologs and paralogs evolve. This is also the expected pattern when they evolve under the same process but paralogs tend to be more distantly related to each other than orthologs are. The fact that multiple pairwise comparisons of developmental gene expression across diverse species share a particular pattern is not evidence of a general process that explains the differences between all species in the analysis. It is also the expected pattern when a single species has unique differences, and the evolutionary changes responsible for these differences are sampled multiple times in pairwise comparisons that span the same phylogenetic branches along which these differences arose. To use patterns across living species to test hypotheses about evolutionary processes it is also necessary to incorporate information about evolutionary relationships, *i.e.* phylogenies. There have been decades of work on building comparative phylogenetic methods that do exactly that, and they are just as relevant to comparing functional genomic traits across species as they are to comparing morphology or any of the other traits they are already routinely applied to.


## Methods

```{r file_status}

	commit_render = system("git log | head -n 1", intern=TRUE) %>% str_replace("commit ", "")

```

All files needed to re-execute the analyses presented in this document are available at https://github.com/caseywdunn/comparative_expression_2017. The most recent commit at the time the analyses were executed was `r commit_kernel %>% strtrim(8)`. The most recent commit at the time of the manuscript was rendered was `r commit_render %>% strtrim(8)`.

### KMRR reanalysis

The KMRR study [@KryuchkovaMostacci:2016iw] followed excellent practices in reproducibility. They posted all data and code needed to re-execute their analyses at figshare: https://figshare.com/articles/Tissue-specificity_of_gene_expression_diverges_slowly_between_orthologs_and_rapidly_between_paralogs/3493010/2 . We slightly altered their `Rscript.R` to simplify file paths and specify one missing variable. This modified script and their data files are available in the github repository for this paper, as are the intermediate files that were generated by their analysis script that we used in our own analyses. We obtained the `Compara.75.protein.nh.emf` gene trees [@Herrero:2016jj] from ftp://ftp.ensembl.org/pub/release-75/emf/ensembl-compara/homologies/ and include them in our github repository. These gene trees include branch lengths, annotate each internal node as being a duplication or speciation event, and provide a clade label for each internal node.

We considered only the data from Brawand *et al.* 2011 [@Brawand:2011du] for the eight taxa included in KMRR. We left in sex chromosome genes and testes expression data, which KMRR removed in some of their sensitivity analyses. This corresponded to the KMRR analyses that provided the strongest support for the ortholog conjecture and therefore the most conservative reconsideration of it.

After parsing the trees from the Compara file with treeio, which was recently split from ggtree [@Yu:2016fo], we added tau estimates generated by the KMRR `Rscript.R` to the tree data objects. We then pruned away tips without expression data, retaining only the trees with `r min_genes_with_expression %>% format(big.mark=",")` or more tips. We also only retained trees with one or more speciation events, as speciation events are required for calibration steps. This removes trees that have multiple genes from only one species after pruning away tips without expression data.

The gene trees were then time calibrated. The goal is not necessarily to have precise dates for each node, but to scale branch lengths so that they are equivalent across gene trees. This in turn scales the phylogenetic independent contrasts (which take branch length into account) so they can be compared appropriately. Before calibrating the trees, we had to slightly modify some of them. The node names in the ENSEMBL Compara [@Herrero:2016jj] gene phylogenies are parsed from the NCBI Taxonomy database, which has many polytomies, rather than a bifurcating species phylogeny. One implication of this is that node names can be resolved so that a speciation node can have the same name as one of its speciation node ancestors, as others have noted [@Daub:2016gd]. If left unaddressed, this would force all intervening branches to have length zero and interfere with calibration. In particular, Hominini is the name for the clade that includes humans and chimps, while Homininae is the clade that includes humans, chimps, and gorillas. Because of the structure of the NCBI Taxonomy, both clades are labeled as Homininae in the Compara trees. To remedy this, we identified all clades labeled Homininae that have no gorilla sequence and renamed them Hominini. We then calibrated the trees by fixing the speciation nodes to the dates specified in the KMRR code, with the exception of Hominini and Homininae. These we set to 7 million years and 9 million years, drawing on the same TimeTree source [@Hedges:2006jv] that KMRR used. We used the `chronos()` function from the R package ape [@Paradis:2004dv] for this calibration, with the `correlated` model. See the *SI Appendix* for additional sensitivity analyses to time calibration. Some trees could not be calibrated with these hard node constraints, and were discarded.

For each node in the remaining calibrated trees, we calculated the phylogenetic independent contrast for tau across its daughter branches with the `pic()` function in ape [@Paradis:2004dv]. Summary statistics on taxon and node sampling are presented in *SI Appendix* Tables S1-S2. We then collected the contrasts from all trees into a single data frame, along with other annotations including whether the node is a speciation or duplication event. This data frame, `nodes_contrast`, was then analyzed as described in the main text for the presented plots and tests. 

### Levin et al. reanalysis

Levin *et al.* helpfully provided data and clarification on methods. We obtained the matrix of pairwise scores that underlies their Fig. 4d and confirmed we could reproduce their published results. We then removed duplicate rows, applied the Wilcoxon test in place of the Kolmogorov-Smirnov test, and identified ctenophores as overrepresented among the low outliers in the mid-developmental transition column. An annotated explanation of these analyses is included in the git repository at https://github.com/caseywdunn/comparative_expression_2017/blob/master/levin_etal/reanalyses.md .

## Acknowledgments

Thanks to Steve Haddock, Alex Damian Serrano, August Guang, Bruno Vellutini, Zack Lewis, and Matthew Hahn for feedback on the manuscript. Marc Robinson-Rechavi provided very helpful information about the KMRR analyses and valuable suggestions for our manuscript. The Ensembl Comparative Genomics team, including Matthieu Muffato, provided excellent support for helping us better understand and use their Compara trees. CWD's contribution was supported by the National Science Foundation (DEB-1256695 and the Waterman Award). AH was supported by the European Research Council Community's Framework Program Horizon 2020 (2014-2020) ERC grant agreement 648861.
\pagebreak

## Supplementary Information

\setcounter{figure}{0}
\makeatletter 
\renewcommand{\thefigure}{S\@arabic\c@figure}
\renewcommand{\thetable}{S\@arabic\c@table}
\makeatother

### KMRR Analyses


#### Summary statistics

```{r contrast_table}

	clades_table = 
		nodes_contrast %>% 
		filter(D=="N") %>% 
		.$label %>% 
		table() %>% 
		as.data.frame()

	names( clades_table ) = c( "Clade", "N" )

	clades_table %<>% slice( match( calibration_times$clade, Clade) )

	knitr::kable(
		clades_table,
		caption = "Number of speciation nodes N with contrasts by clade name."
	)
```

```{r species_table}

	nodes_all = 
			lapply( 
				gene_trees_pic, 
				function( nhx ){
					tags = nhx@data
					tags$gene = digest( nhx ) # Creates a hash that is unique to each gene tree
					tags %<>% select( -( B ) ) # B has inconsistent types, remove it
					return( tags )
				}
			) %>%
			bind_rows() %>%
			mutate( pic = abs( pic ) )

	
	species_table = 
		nodes_all %>% 
		filter( ! is.na( species ) ) %>% 
		.$species %>% 
		table() %>% 
		as.data.frame()

	names( species_table ) = c( "Species", "N" )
	
	species_table %<>% 
		arrange( Species ) %>%
		mutate( Species = str_replace( Species, "_", "Q") ) %>%
		mutate( Species = str_to_title( Species ) ) %>%
		mutate( Species = str_replace( Species, "q", " ") )
	
	knitr::kable(
		species_table,
		caption = "Number of tips N for each species in trees that were used to calculate the independent contrasts."
	)


```

```{r Fig_S1, fig.width=7, fig.height=6.5, fig.cap="One of the gene trees from the phylogenetic analysis. The value of tau (expression specificity) is indicated by the sizes of the circles at the tips of the tree. Whether an internal node is a speciation or duplication is indicated by color. Speciation nodes are labeled by clade name. Branch lengths are scaled to time. The blue number is the independent contrast for each node."}

	ntips = lapply( gene_trees_pic, function(x) length( x@phylo$tip.label ))
	to_show = which( ntips < 20 & ntips >15 )[1:8]
	
	example_trees = lapply( 
		to_show,
		function( x ){
				nhx = gene_trees_pic[[x]]
				nhx@data %<>% mutate( clade_name=label )
				nhx@data$clade_name[ is.tip.nhx(nhx) | nhx@data$D !="N" ] = NA
				
				nhx %>% 
					ggtree() + 
					geom_tiplab( aes( label=species ), hjust=-0.1 ) + 
					xlim( 0, 400 ) + 
					geom_tippoint( aes( size=Tau ) ) +
					geom_nodepoint( aes( color=Event ), shape=15, size = 2 ) +
					geom_tippoint( aes( size=Tau ) ) +
					geom_text( aes( label=round( abs( pic ), 3 ) ), vjust=1.5, hjust=1, size=2.5, col="blue" ) + 
					geom_text( aes( label=clade_name ), vjust=-.5, hjust=1, size=2.5, col="black" ) + 
					theme( legend.position="right" )
			}
		)
	
	print( example_trees[[6]] )
```

#### Phylogenetic signal and models of evolution

```{r Fig_S2, fig.width=5, fig.height=3, fig.cap="Density plot of Blomberg's K. The shaded portion of the plot indicates the gene trees that were analyzed after excluding the trees that fell below the K threshold."}

	max_k = 2
	dens = density(tree_summary$K[ !is.na(tree_summary$K) ], from = 0, to = max_k)
	D = data.frame(x = dens$x, y = dens$y)
	thresh = k_thresh
	shade = rbind(c(max_k, 0), c(thresh,0), subset(D, x > thresh))
	
	thresh_label = paste( "\nthreshold: > ", round(thresh,2), sep='' )
	
	g_k_density = 
		ggplot(D, aes(x,y)) + 
			geom_line() + 
			geom_polygon( data = shade, aes(x, y) ) +
			xlab("K") +
			ylab("density") +
			theme_classic() +
			geom_vline(xintercept = thresh, col="grey") +
			geom_text(aes(x=thresh, label=thresh_label, y=mean(range(y))), colour="grey", angle=90) +
			ggtitle( "" )
	
	g_k_density

```

The gene trees considered here vary widely in their phylogenetic signal for tau according to Blomberg's $K$ [@Blomberg:2003jg] (*SI Appendix*, Fig. S2). $K$ describes the tendency for closely related tips to resemble each other, where $K=0$ indicates that close relatives resemble each other no more than they do distant relatives and $K=1$ indicates that the data have strong phylogenetic signal. To examine the possibility that gene trees with little phylogenetic signal were diluting support for the Ortholog Conjecture, we removed the `r k_percentile` of genes with the lowest phylogenetic signal, corresponding to a $K$ cutoff for retained genes of greater than `r signif( k_thresh, 3)`. Repeating the phylogenetic analyses on this subset of genes with strongest phylogenetic signal for tau still do not reject the null hypothesis (Wilcoxon $P=`r  wilcox_test_result_k %>% round( 3 )`$). This indicates that gene trees with little phylogenetic signal are not obscuring support for the Ortholog Conjecture in genes with greater phylogenetic signal.

Phylogenetic independent contrasts (PICs) are based on a Brownian Motion (BM) model of character evolution [@Felsenstein:1985ua]. PICs could fail to reject the null hypothesis if BM is not a good model for the evolution of tau on the gene phylogenies. We therefore compared the fit of BM to the more complex Ornstein Uhlenbeck (OU) model of evolution with the Akaike Information Criterion (AIC) [@Akaike:1974ih; @Posada:2004ix]. 

We fit BM and OU models for the evolution of tau on each gene tree with the R package geiger [@Pennell:2014jf]. This produced parameter estimates and AIC scores, $AIC_{BM}$ and $AIC_{OU}$, for each tree for each model. For each tree, we then calculated the AIC differences $\Delta AIC$ for each model as $\Delta AIC_{BM}=AIC_{BM}-min(AIC_{BM}, AIC_{OU})$ and $\Delta AIC_{OU}=AIC_{OU}-min(AIC_{BM}, AIC_{OU})$. The lower the $\Delta AIC$ for a model, the more plausible it is. $\Delta AIC<2$ is generally regarded as substantial relative support for a model. If multiple models have a low $\Delta AIC$, then there is little difference in the plausibility of the models. Since we are only considering two models, for each gene tree either $\Delta AIC_{BM}$ or $\Delta AIC_{OU}$ (or both) will be $0$. 

Of the `r nrow(tree_summary)` genes considered, `r sum(tree_summary$dAIC_bm < dAIC_thresh & tree_summary$dAIC_ou >= dAIC_thresh)` have $\Delta AIC_{BM} < `r dAIC_thresh`$ and $\Delta AIC_{OU} \geq `r dAIC_thresh`$, `r sum(tree_summary$dAIC_bm >= dAIC_thresh & tree_summary$dAIC_ou < dAIC_thresh)` have $\Delta AIC_{OU} < `r dAIC_thresh`$ and $\Delta AIC_{BM} \geq `r dAIC_thresh`$, and `r sum(tree_summary$dAIC_bm < dAIC_thresh & tree_summary$dAIC_ou < dAIC_thresh)` have both $\Delta AIC_{OU} < `r dAIC_thresh`$ and $\Delta AIC_{BM} < `r dAIC_thresh`$. That gives a total of `r sum( tree_summary$dAIC_bm < dAIC_thresh )` genes that have $\Delta AIC_{BM} < `r dAIC_thresh`$ and `r sum( tree_summary$dAIC_ou < dAIC_thresh )` genes that have $\Delta AIC_{OU} < `r dAIC_thresh`$ (these sets of genes are overlapping, so their total is more than the number of genes considered). 

Repeating the BM phylogenetic analyses on the subset of `r sum( tree_summary$dAIC_bm < dAIC_thresh )` genes for which $\Delta AIC_{BM} < `r dAIC_thresh`$ still does not reject the null hypothesis (Wilcoxon $P=`r  wilcox_test_result_bm %>% round( 3 )`$) that the rate of evolution of tau is the same after duplication and speciation events.

We next approximated the phylogenetic independent contrasts for the the `r sum( tree_summary$dAIC_ou < dAIC_thresh )` genes for which $\Delta AIC_{OU} < `r dAIC_thresh`$. These analyses do not reject the null hypothesis either (Wilcoxon $P=`r  wilcox_ou %>% round( 3 )`$). The challenge with such an analysis is that BM is intrinsic to the classic implementation of phylogenetic independent contrasts, which use the fact that the expected variance is proportional to branch length to scale each contrast. Under OU, branch length no longer has a linear relationship to expected variance. We therefore took an alternative simulation-based approach to scaling the OU contrasts. We implemented this new method, which we call picx (for "pic extended models"), in our R package hutan (https://github.com/caseywdunn/hutan). For each tree, picx first estimate the model parameters from the observed data. It then simulates two hundred datasets under these parameters, recording both the internal and tip node states. It then scales the observed contrasts by the mean magnitude of the corresponding contrasts in the simulations. We validated the method by comparing picx BM results to the standard pic results calculated by ape [@Paradis:2004dv]. These validations indicated a strong linear relationship between the two ($R^2=0.98$, $P=1.39\times 10^{-23}$). This approach could be extended to approximate phylogenetic independent contrasts under other continuous models of evolution as well.

These analyses indicate that our inability to reject the null hypothesis is robust under different models of tau evolution.

#### Investigation of potential ascertainment bias

While the age of speciation nodes is constrained, duplication nodes can be much older and therefore have a wider range of ages (*SI Appendix*, Fig. S3*A*). This is because many gene duplication events are older than the most recent common ancestor of the species in the study. There are also technical factors that can lead to an excess of duplication events deeper in the tree. Gene tree estimation errors, for example, tend to lead to the overestimation of deep duplications [@Hahn:2007cj]. If independent contrast values also tended to be lower at greater node depth, it could interact with the preponderance of duplications at greater depth to create a pattern of lower contrasts associated with duplication events. To test for such an effect, we remove duplication nodes that are older than the oldest speciation node. The general results are unchanged and this reduced dataset does not reject the null hypothesis that the rate of evolution following duplications is the same as or less than the rate following speciation (*SI Appendix*, Fig. S3*B*).

The independent contrast across a node is the amount of change observed between the daughter nodes, scaled by the expected variance [@Felsenstein:1985ua]. The expected variance is principally determined by the lengths of the branches leading from the node to these daughters. The shorter the total length of the two branches leading to daughter nodes, the larger the contrast for a given observed difference. This is because the same difference across a shorter total branch length indicates a greater rate of evolutionary change. The expected variance of contrasts for speciation nodes is constrained by the branch lengths on the species tree, but the expected variance of contrasts for duplications has a much wider range (*SI Appendix*, Fig. S3*C*). This could lead to biases if the lengths of branches that descend from duplication nodes tend to be overestimated. We therefore examined only the contrasts that fell within the range of expected variance seen for speciation contrasts, excluding duplication contrasts that fall outside of this range. This reanalysis does not reject the null hypothesis either (*SI Appendix*, Fig. S3*D*), indicating that branch length bias is not responsible for the result.

```{r Fig_S3, fig.width=7, fig.height=6.5, fig.cap="Investigation of possible ascertainment biases. (*A*) Magnitude of independent contrasts plotted against node age. Speciation nodes are calibrated to particular times, whereas duplication nodes have a wider range. (*B*) Difference between density distributions of contrasts for only the nodes that have an age less than or equal to the maximum age of speciation nodes. (*C*) Magnitude of independent contrasts plotted against expected variance, which is largely determined by branch lengths. Contrasts for speciation nodes have a narrower range of expected variance than do contrasts for duplication nodes. (*D*) Difference between density distributions of contrasts for only the nodes that have expected variance within the range of contrasts across speciation nodes."}

	g_age =
		nodes_contrast %>%
		ggplot( aes( x=node_age, y=pic, col=Event ) ) + 
			geom_point( alpha=0.2, size = 0.5 ) + 
			xlab( "Node age (millions of years)" ) + 
			ylab( "Phylogenetic independent \ncontrast" ) +
			ylim( 0, 0.3 ) +
			xlim( 0, 1000 ) +
			ggtitle( "A" ) +
			theme_classic()	+
			guides( colour = guide_legend( override.aes = list( alpha = 1, size = 2 ) ) ) +
			theme( legend.justification=c( 1, 1 ), legend.position=c( 1, 1 ) )


	# Examine by expected variance (branch length)
	g_var_exp =
		nodes_contrast %>%
		ggplot( aes( x=var_exp, y=pic, col=Event ) ) + 
		geom_point( alpha=0.2, size = 0.5 ) + 
		xlab( "Expected variance, \n depends mostly on branch length" ) + 
		ylab( "Phylogenetic independent \ncontrast" ) +
		ylim( 0, 0.3 ) +
		xlim( 0, 2000 ) +
		ggtitle( "C" ) +
		theme_classic()	+
		theme(legend.position="none")

	grid.arrange(
		g_age,
		make_contrast_plot( nodes_contrast_filtered_age ) + ggtitle( "B" ),
		g_var_exp,
		make_contrast_plot( nodes_contrast_filtered_var ) + ggtitle( "D" ),
		ncol = 2
	)
```


```{r Fig_S4, fig.width=7, fig.height=3, fig.cap="Investigation of the potential impact of within-species variance. These plots correspond to Fig. 2*A* and 2*B*, but with increased expected within-species variation modeled by increasing the terminal gene phylogeny branch lengths. (*A*) Pairwise comparisons still recover higher correlation across speciation events than duplication events. (*B*) There is not an excess of larger contrasts for duplication events and the analysis does not reject the null hypothesis. Modeling a large amount of within-species variation does not lead to support for the ortholog conjecture."}

	g_pair_extended = 
		pairwise_extended_summary %>% 
			filter( ! is.na( D ) ) %>%
			group_by( Event, label ) %>% 
			summarise( cor.test( tau_a, tau_b )$estimate, n=n() ) %>% 
			rename( rho=`cor.test(tau_a, tau_b)$estimate` ) %>%
			rename( clade = label ) %>% 
			left_join( calibration_times, clade=clade ) %>%
			ggplot() + 
				geom_point( aes( x=age, y=rho, col=Event ), size=3 ) +
				theme_classic() +
				xlab( "Clade Age (million years)" ) +
				ylab( "Correlation Coefficient" ) +
				ylim( 0, 1 ) +
				ggtitle( "A Pairwise" ) +
				guides( colour = guide_legend( override.aes = list( shape = 15 ) ) ) +
				theme( 
				legend.justification=c( 1, 1 ), 
				legend.position=c( 1, 1 ), 
				legend.title=element_blank() )

	grid.arrange(
		g_pair_extended,
		make_contrast_plot( nodes_extended_contrast ) + 
			ggtitle( "B Phylogenetic" ),
		ncol = 2
	)
```



#### Investigation of sensitivity to calibration times

We examined the sensitivity of our results to the specification of calibration dates for the speciation nodes. In `r noised_replicate_n` reanalyses, we drew a new date for each calibration from a normal distribution with the mean of the original date and a standard deviation `r sd_fraction` times the original date. If any daughter nodes became older than their parent, we repeated the sampling until the dates were congruent with the topology. The minimum Wilcoxon $P$ in these reanalyses was $`r min( as.numeric( unlist( p_noised ) ) )`$, *i.e.* none of them reject the null hypothesis that the rate of evolution of tau is greater following duplication events than speciation events. This is consistent with the analysis that uses the calibration dates as specified, indicating that our results are robust to the selection of calibration times for speciation nodes.

```{r Fig_S5, fig.width=7, fig.height=3, fig.cap="Origin of pairwise correlation plot structure. (*A*) Each speciation and duplication node in the COMPARA trees is annotated with a clade name, and the age of that clade (shown on the x axis) is used as the age of the pairwise comparisons (Fig. 2 *A, C, E*, KMRR [@KryuchkovaMostacci:2016iw] Fig. 2). The clade ages have a clear correspondence to the speciation node ages (red). Duplication (blue) ages for nodes assigned to the same clade, however, have large variation in calibrated node age (y axis). This means that summaries of expression differences across duplication events represent evolutionary changes that occurred over a wide range of time scales. (*B*) When duplication nodes whose calibrated node age deviates more than 10% from their annotated clade age are removed from the data simulated under the null distribution, duplication comparisons no longer have a uniformly lower expression correlation than speciation comparisons."} 
	
	grid.arrange(
		g_clade_age,
		g_sub,
		ncol = 2
		)

```


#### Relationship between tau and maximum expression

```{r Fig_S6, fig.width=3.42, fig.height=3.42, fig.cap="Genes with higher maximum observed expression tend to have lower tau. The blue line is the linear model for the relationship between the two."}

	nodes_tips = nodes_all %>% filter( ! is.na( species ) )
	max_expression = nodes_tips %>% select( contains("Averaged") ) %>% apply( 1, FUN=max, na.rm=TRUE )
	nodes_tips$max_expression = max_expression
	
	tau_v_max_lm = lm(nodes_tips$Tau ~ nodes_tips$max_expression) %>% summary()
	
	ggplot( nodes_tips, aes( x=max_expression, y=Tau ) ) + 
		geom_point( size=0.5, alpha = 0.05 ) + 
		geom_smooth( method="lm", se=FALSE ) +
		xlab( "Maximum Expression" ) +
		ylim( 0, 1 ) +
		theme_classic()
	
```

KMRR [@KryuchkovaMostacci:2016iw] Fig. 3 differs from their other analyses in that it presents independent changes in expression between triplets of genes. Each triplet has two paralogs that arose from a duplication event and one unduplicated homolog. They find that there is a tendency for the paralog with the lowest expression to have the highest tau. From this they conclude that following duplication there is a common trajectory of evolutionary change, where one paralog evolves to have lower expression and also become more tissue specific. There is, however, a negative relationship between tau and maximum expression across all genes (*SI Appendix* Fig. S6, $r^2=`r signif( tau_v_max_lm$r.squared, 3 )`$, $slope=`r signif( tau_v_max_lm$coefficients[2,1], 3 )`$, $P=`r signif( tau_v_max_lm$coefficients[2,4], 3 )`$). A simpler explanation for their plot is that it reflects the global tendency for tau to decrease with maximum expression. The null expectation for any two genes sampled at random is for one to have higher maximum expression and lower tau, and the other to have lower maximum expression and higher tau. This global pattern could be due to both biological factors and the technical details of how tau is calculated.


\pagebreak

### Software versions

These analyses were computed on `r format( system_time_kernel, "%a %b %d %X %Y" )` with the following R package versions. The total run time of these analyses was `r time_run %>% as.numeric() %>% round( 2 )` hours on a `r cores+1` core machine.

```{r session_summary, comment=NA}
	session_info_kernel
```

This manuscript was rendered from these analyses on `r format( system_time_kernel, "%a %b %d %X %Y" )`.

\pagebreak

## References
